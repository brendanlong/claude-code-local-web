services:
  app:
    image: ghcr.io/brendanlong/clawed-burrow:latest
    # Label for podman auto-update to check for new images
    labels:
      - io.containers.autoupdate=registry
    ports:
      - '3000:3000'
    environment:
      - DATABASE_URL=file:/data/db/prod.db
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      # Host path to Claude auth directory - used for bind mounts in session containers
      - CLAUDE_AUTH_PATH=${HOME}/.claude
      # Path inside this container where data is mounted (for filesystem operations)
      - DATA_DIR=/data
      # Host path to data directory - used for bind mounts when creating session containers
      - DATA_HOST_PATH=${HOME}/.clawed-burrow
      - NODE_ENV=production
      - PASSWORD_HASH=${PASSWORD_HASH}
      # Tell the app which runner image to use for Claude sessions
      - CLAUDE_RUNNER_IMAGE=ghcr.io/brendanlong/clawed-burrow-runner:latest
      # Optional: shared pnpm store path on host (for faster installs)
      - PNPM_STORE_PATH=${PNPM_STORE_PATH:-}
      # Optional: shared Gradle cache path on host (for faster builds)
      - GRADLE_USER_HOME=${GRADLE_USER_HOME:-}
    volumes:
      - ${HOME}/.clawed-burrow:/data
      # Mount podman socket for container management
      # For rootless podman: /run/user/$(id -u)/podman/podman.sock
      # For rootful podman: /run/podman/podman.sock
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/podman/podman.sock:/var/run/docker.sock
      - ${HOME}/.claude:/claude-auth
    # GPU access via CDI (Container Device Interface)
    # Requires: sudo nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
    devices:
      - nvidia.com/gpu=all
    security_opt:
      # Required for CDI GPU access
      - label=disable
    restart: unless-stopped

# To enable automatic updates, use podman's built-in auto-update feature:
# 1. Enable the systemd timer: systemctl --user enable --now podman-auto-update.timer
# 2. Or run manually: podman auto-update
#
# For remote access, we recommend using Tailscale Funnel on the host
# See: https://tailscale.com/kb/1223/funnel

# Data is stored in ~/.clawed-burrow on the host
